{% extends "base.html" %}
{% block title %}管理后台{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">管理后台</h1>

    <!-- Tabs -->
    <div class="border-b mb-6 flex flex-wrap text-sm font-medium text-center text-gray-500">
        <button class="tab-btn active px-4 py-2 border-b-2 border-blue-600 text-blue-600" data-tab="users">用户管理</button>
        <button class="tab-btn px-4 py-2 hover:text-blue-600" data-tab="articles">文章管理</button>
        <button class="tab-btn px-4 py-2 hover:text-blue-600" data-tab="settings">设置</button>
        <button class="tab-btn px-4 py-2 hover:text-blue-600" data-tab="monitor">监控</button>
    </div>

    <!-- 用户管理 -->
    <div class="tab-content" id="tab-users">
        <div class="flex flex-col gap-4">
            <button class="bg-blue-600 text-white px-4 py-1 rounded w-32" onclick="openAddUserPopup()">添加用户</button>
            <table class="w-full border border-gray-200 text-left mt-2">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2">用户名</th>
                        <th class="px-3 py-2">角色</th>
                        <th class="px-3 py-2 text-right">操作</th>
                    </tr>
                </thead>
                <tbody id="user-table" class="text-gray-700"></tbody>
            </table>

            <!-- 分页 -->
            <div class="flex justify-between items-center mt-2">
                <button id="prev-user-page" class="px-2 py-1 border rounded">上一页</button>
                <span id="user-page-info"></span>
                <button id="next-user-page" class="px-2 py-1 border rounded">下一页</button>
            </div>
        </div>
    </div>

    <!-- 文章管理 -->
    <div class="tab-content hidden" id="tab-articles">
        <div class="flex flex-col gap-4">
            <ul id="article-list" class="divide-y border rounded"></ul>

            <!-- 分页 -->
            <div class="flex justify-between items-center mt-2">
                <button id="prev-article-page" class="px-2 py-1 border rounded">上一页</button>
                <span id="article-page-info"></span>
                <button id="next-article-page" class="px-2 py-1 border rounded">下一页</button>
            </div>
        </div>
    </div>

    <!-- 设置 -->
    <div class="tab-content hidden" id="tab-settings">
        <div class="space-y-4">
            <label class="flex items-center">
                <input type="checkbox" id="allow-register" class="mr-2">
                允许用户注册
            </label>
            <button class="bg-blue-600 text-white px-4 py-1 rounded" onclick="saveSettings()">保存设置</button>
        </div>
    </div>

    <!-- 监控 -->
    <div class="tab-content hidden" id="tab-monitor">
        <div class="flex flex-col gap-4">
            <div class="flex gap-2 flex-wrap">
                <button class="bg-blue-600 text-white px-4 py-1 rounded" onclick="startGenerator()">启动生成器</button>
                <button class="bg-red-600 text-white px-4 py-1 rounded" onclick="stopGenerator()">停止生成器</button>
            </div>
            <div class="border rounded bg-black text-green-400 font-mono p-3 h-64 overflow-y-auto text-sm" id="log-box"></div>
        </div>
    </div>
</div>

<!-- 添加/修改用户弹窗 -->
<div id="user-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg w-80 p-6 relative">
        <h2 class="text-xl font-bold mb-4" id="popup-title">添加用户</h2>
        <input type="text" id="popup-username" placeholder="用户名" class="border rounded px-2 py-1 w-full mb-2">
        <input type="password" id="popup-password" placeholder="密码" class="border rounded px-2 py-1 w-full mb-2">
        <select id="popup-role" class="border rounded px-2 py-1 w-full mb-4">
            <option value="1">User</option>
            <option value="2">Admin</option>
        </select>
        <div class="flex justify-end gap-2">
            <button class="px-3 py-1 rounded border" onclick="closeUserPopup()">取消</button>
            <button class="px-3 py-1 rounded bg-blue-600 text-white" id="popup-submit">确定</button>
        </div>
    </div>
</div>

<script>
    // Tab 切换
    document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active", "text-blue-600", "border-blue-600"));
            btn.classList.add("active", "text-blue-600", "border-blue-600");
            document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
            document.querySelector("#tab-" + btn.dataset.tab).classList.remove("hidden");
        });
    });

    const usernameRegex = /^[A-Za-z0-9]{3,15}$/;
    const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]{8,20}$/;

    let userPage = 1, userTotalPages = 1;
    const userPageSize = 10;
    let editUsername = null;

    async function loadUsers(page = 1) {
        const res = await fetch(`/api/users?page=${page}&page_size=${userPageSize}`);
        const data = await res.json();
        const tbody = document.getElementById("user-table");
        tbody.innerHTML = "";
        data.items.forEach(u => {
            tbody.innerHTML += `
                <tr>
                    <td class="px-3 py-2">${u.username}</td>
                    <td class="px-3 py-2">${u.role == 1 ? 'User' : 'Admin'}</td>
                    <td class="px-3 py-2 text-right flex flex-col sm:flex-row gap-1 sm:justify-end">
                        <button class="bg-yellow-400 text-white px-2 py-0.5 rounded text-sm" onclick="openEditUserPopup('${u.username}', ${u.role})">修改</button>
                        <button class="bg-red-600 text-white px-2 py-0.5 rounded text-sm" onclick="deleteUser('${u.username}')">删除</button>
                    </td>
                </tr>
            `;
        });
        userPage = data.page;
        userTotalPages = data.total_pages;
        document.getElementById("user-page-info").textContent = `第 ${data.page} 页 / 共 ${data.total_pages} 页`;
        document.getElementById("prev-user-page").disabled = userPage <= 1;
        document.getElementById("next-user-page").disabled = userPage >= userTotalPages;
    }

    function openAddUserPopup() {
        editUsername = null;
        document.getElementById("popup-title").textContent = "添加用户";
        document.getElementById("popup-username").value = "";
        document.getElementById("popup-username").disabled = false;
        document.getElementById("popup-password").value = "";
        document.getElementById("popup-role").value = "1";
        document.getElementById("user-popup").classList.remove("hidden");
        document.getElementById("popup-submit").onclick = submitUserPopup;
    }

    function openEditUserPopup(username, role) {
        editUsername = username;
        document.getElementById("popup-title").textContent = "修改用户";
        document.getElementById("popup-username").value = username;
        document.getElementById("popup-username").disabled = true;
        document.getElementById("popup-password").value = "";
        document.getElementById("popup-role").value = role;
        document.getElementById("user-popup").classList.remove("hidden");
        document.getElementById("popup-submit").onclick = submitUserPopup;
    }

    function closeUserPopup() {
        document.getElementById("user-popup").classList.add("hidden");
    }

    async function submitUserPopup() {
        const username = document.getElementById("popup-username").value;
        const password = document.getElementById("popup-password").value;
        const role = parseInt(document.getElementById("popup-role").value);

        if (!usernameRegex.test(username)) return;
        if (!editUsername && !passwordRegex.test(password)) return;

        if (editUsername) {
            // 修改用户
            let body = {role};
            if (password) body.password = password;
            await fetch(`/api/users/${editUsername}`, {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(body)
            });
        } else {
            // 添加用户
            await fetch("/api/users", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({username, password, role})
            });
        }
        closeUserPopup();
        loadUsers(userPage);
    }

    async function deleteUser(username) {
        await fetch(`/api/users/${username}`, {method: "DELETE"});
        loadUsers(userPage);
    }

    document.getElementById("prev-user-page").addEventListener("click", () => {
        if (userPage > 1) loadUsers(userPage - 1);
    });
    document.getElementById("next-user-page").addEventListener("click", () => {
        if (userPage < userTotalPages) loadUsers(userPage + 1);
    });

    loadUsers(); // 初始化用户

    // ---------- 文章管理 ----------
    let articlePage = 1, articleTotalPages = 1;
    const articlePageSize = 10;

    async function loadArticles(page = 1) {
        const res = await fetch(`/api/articles?page=${page}&page_size=${articlePageSize}`);
        const data = await res.json();
        const list = document.getElementById("article-list");
        list.innerHTML = "";
        data.items.forEach(a => {
            list.innerHTML += `
                <li class="flex justify-between items-center px-3 py-2">
                    <span>${a.title}</span>
                    <button class="text-red-600" onclick="deleteArticle('${a.id}')">删除</button>
                </li>
            `;
        });
        articlePage = data.page;
        articleTotalPages = data.total_pages;
        document.getElementById("article-page-info").textContent = `第 ${data.page} 页 / 共 ${data.total_pages} 页`;
        document.getElementById("prev-article-page").disabled = articlePage <= 1;
        document.getElementById("next-article-page").disabled = articlePage >= articleTotalPages;
    }

    async function deleteArticle(id) {
        await fetch(`/api/articles/${id}`, {method: "DELETE"});
        loadArticles(articlePage);
    }

    document.getElementById("prev-article-page").addEventListener("click", () => {
        if (articlePage > 1) loadArticles(articlePage - 1);
    });
    document.getElementById("next-article-page").addEventListener("click", () => {
        if (articlePage < articleTotalPages) loadArticles(articlePage + 1);
    });

    loadArticles(); // 初始化文章

    // ---------- 设置 ----------
    async function saveSettings() {
        const allow = document.getElementById("allow-register").checked;
        await fetch("/api/settings", {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({allow_register: allow})
        });
    }

    // ---------- 监控 SSE ----------
    const logBox = document.getElementById("log-box");
    const evtSource = new EventSource("/api/generator/logs");
    evtSource.onmessage = function(e) {
        logBox.innerHTML += `<div>${e.data}</div>`;
        logBox.scrollTop = logBox.scrollHeight;
    };

    async function startGenerator() {
        await fetch("/api/generator/start", {method: "POST"});
    }

    async function stopGenerator() {
        await fetch("/api/generator/stop", {method: "POST"});
    }
</script>

<style>
    @media (max-width: 640px) {
        .tab-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 0.9rem; }
    }
</style>
{% endblock %}
