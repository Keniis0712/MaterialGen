{% extends "base.html" %}
{% block title %}管理后台{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">管理后台</h1>

    <!-- Tabs -->
    <div class="border-b mb-6 flex flex-wrap text-sm font-medium text-center text-gray-500">
        <button class="tab-btn active px-4 py-2 border-b-2 border-blue-600 text-blue-600" data-tab="users">用户管理</button>
        <button class="tab-btn px-4 py-2 hover:text-blue-600" data-tab="articles">文章管理</button>
        <button class="tab-btn px-4 py-2 hover:text-blue-600" data-tab="settings">设置</button>
        <button class="tab-btn px-4 py-2 hover:text-blue-600" data-tab="monitor">监控</button>
    </div>

    <!-- 用户管理 -->
    <div class="tab-content" id="tab-users">
        <div class="flex flex-col gap-4">
            <div class="flex flex-col sm:flex-row gap-2">
                <input id="new-username" type="text" placeholder="用户名" class="border rounded px-2 py-1 flex-1">
                <input id="new-password" type="password" placeholder="密码" class="border rounded px-2 py-1 flex-1">
                <button class="bg-blue-600 text-white px-4 py-1 rounded" onclick="addUser()">添加用户</button>
            </div>
            <table class="w-full border border-gray-200 text-left">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2">用户名</th>
                        <th class="px-3 py-2">角色</th>
                        <th class="px-3 py-2 text-right">操作</th>
                    </tr>
                </thead>
                <tbody id="user-table" class="text-gray-700"></tbody>
            </table>
        </div>
    </div>

    <!-- 文章管理 -->
    <div class="tab-content hidden" id="tab-articles">
        <div class="flex flex-col gap-4">
            <div class="flex flex-col sm:flex-row gap-2">
                <input id="new-article" type="text" placeholder="文章标题" class="border rounded px-2 py-1 flex-1">
                <button class="bg-green-600 text-white px-4 py-1 rounded" onclick="addArticle()">添加文章</button>
            </div>
            <ul id="article-list" class="divide-y border rounded"></ul>
        </div>
    </div>

    <!-- 设置 -->
    <div class="tab-content hidden" id="tab-settings">
        <div class="space-y-4">
            <label class="flex items-center">
                <input type="checkbox" id="allow-register" class="mr-2">
                允许用户注册
            </label>
            <button class="bg-blue-600 text-white px-4 py-1 rounded" onclick="saveSettings()">保存设置</button>
        </div>
    </div>

    <!-- 监控 -->
    <div class="tab-content hidden" id="tab-monitor">
        <div class="flex flex-col gap-4">
            <div class="flex gap-2 flex-wrap">
                <button class="bg-blue-600 text-white px-4 py-1 rounded" onclick="startGenerator()">启动生成器</button>
                <button class="bg-red-600 text-white px-4 py-1 rounded" onclick="stopGenerator()">停止生成器</button>
            </div>
            <div class="border rounded bg-black text-green-400 font-mono p-3 h-64 overflow-y-auto text-sm" id="log-box">
                <div class="opacity-70">[系统] 日志输出区域...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // Tab 切换
    document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active", "text-blue-600", "border-blue-600"));
            btn.classList.add("active", "text-blue-600", "border-blue-600");

            document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
            document.querySelector("#tab-" + btn.dataset.tab).classList.remove("hidden");
        });
    });

    // 示例：加载用户列表
    async function loadUsers() {
        const res = await fetch("/api/users");
        const users = await res.json();
        const tbody = document.getElementById("user-table");
        tbody.innerHTML = "";
        users.forEach(u => {
            tbody.innerHTML += `
                <tr>
                    <td class="px-3 py-2">${u.username}</td>
                    <td class="px-3 py-2">${u.role}</td>
                    <td class="px-3 py-2 text-right">
                        <button class="text-blue-600 mr-2" onclick="resetPassword('${u.username}')">重置密码</button>
                        <button class="text-red-600" onclick="deleteUser('${u.username}')">删除</button>
                    </td>
                </tr>
            `;
        });
    }

    async function addUser() {
        const username = document.getElementById("new-username").value;
        const password = document.getElementById("new-password").value;
        await fetch("/api/users", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({username, password})
        });
        loadUsers();
    }

    async function deleteUser(username) {
        await fetch(`/api/users/${username}`, {method: "DELETE"});
        loadUsers();
    }

    async function resetPassword(username) {
        const newPass = prompt("输入新密码：");
        if (!newPass) return;
        await fetch(`/api/users/${username}/password`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({password: newPass})
        });
        alert("密码已修改");
    }

    async function addArticle() {
        const title = document.getElementById("new-article").value;
        await fetch("/api/articles", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({title})
        });
        loadArticles();
    }

    async function loadArticles() {
        const res = await fetch("/api/articles");
        const articles = await res.json();
        const list = document.getElementById("article-list");
        list.innerHTML = "";
        articles.forEach(a => {
            list.innerHTML += `
                <li class="flex justify-between items-center px-3 py-2">
                    <span>${a.title}</span>
                    <button class="text-red-600" onclick="deleteArticle('${a.id}')">删除</button>
                </li>
            `;
        });
    }

    async function deleteArticle(id) {
        await fetch(`/api/articles/${id}`, {method: "DELETE"});
        loadArticles();
    }

    async function saveSettings() {
        const allow = document.getElementById("allow-register").checked;
        await fetch("/api/settings", {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({allow_register: allow})
        });
        alert("设置已保存");
    }

    async function startGenerator() {
        await fetch("/api/generator/start", {method: "POST"});
        appendLog("[系统] 生成器已启动");
    }

    async function stopGenerator() {
        await fetch("/api/generator/stop", {method: "POST"});
        appendLog("[系统] 生成器已停止");
    }

    function appendLog(line) {
        const box = document.getElementById("log-box");
        box.innerHTML += `<div>${new Date().toLocaleTimeString()} ${line}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    // 初始化加载
    loadUsers();
    loadArticles();
</script>

<style>
    @media (max-width: 640px) {
        .tab-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 0.9rem; }
    }
</style>
{% endblock %}
